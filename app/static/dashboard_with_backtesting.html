<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Dashboard - With Backtesting</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        /* Tab Navigation */
        .tab-navigation {
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .tab-buttons {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        
        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tab-button:hover {
            background: #e9ecef;
            color: #495057;
        }
        
        .tab-button.active {
            background: white;
            color: #3498db;
            border-bottom: 3px solid #3498db;
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #3498db;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Common Card Styles */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        /* Button Styles */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; transform: translateY(-1px); }
        
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #229954; }
        
        .btn-warning { background: #f39c12; color: white; }
        .btn-warning:hover { background: #d68910; }
        
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-secondary:hover { background: #7f8c8d; }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Preset Cards */
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .preset-card {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .preset-card:hover {
            border-color: #3498db;
            background: #e3f2fd;
            transform: translateY(-2px);
        }
        
        .preset-card.selected {
            border-color: #3498db;
            background: #e3f2fd;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.2);
        }
        
        .preset-card h4 {
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .preset-card p {
            color: #7f8c8d;
            font-size: 13px;
            margin-bottom: 8px;
        }
        
        .preset-symbols {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .symbol-tag {
            background: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }
        
        /* Results Display */
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .metric-label {
            color: #7f8c8d;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-positive { color: #27ae60; }
        .metric-negative { color: #e74c3c; }
        .metric-neutral { color: #7f8c8d; }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            padding: 15px;
        }
        
        /* Trade Log */
        .trade-log {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        
        .trade-item {
            background: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #3498db;
            font-size: 13px;
        }
        
        .trade-item.profit { border-left-color: #27ae60; }
        .trade-item.loss { border-left-color: #e74c3c; }
        
        .trade-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .trade-details {
            color: #7f8c8d;
            font-size: 11px;
        }
        
        /* Status and Loading */
        .status-running { color: #27ae60; }
        .status-stopped { color: #e74c3c; }
        .status-loading { color: #f39c12; }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
            animation: progress-shine 2s infinite;
        }
        
        @keyframes progress-shine {
            0% { background-position: -200px 0; }
            100% { background-position: 200px 0; }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .tab-buttons {
                flex-direction: column;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .preset-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Alert Messages */
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert-danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 Trading Bot Dashboard</h1>
            <p>Complete Stock Trading & Backtesting Platform</p>
            <p id="status-message" class="status-running">All Systems Ready</p>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('live-trading')">
                    📊 Live Trading
                </button>
                <button class="tab-button" onclick="showTab('backtesting')">
                    🧪 Backtesting
                </button>
                <button class="tab-button" onclick="showTab('positions')">
                    📈 Positions
                </button>
                <button class="tab-button" onclick="showTab('analysis')">
                    🔍 Analysis
                </button>
                <button class="tab-button" onclick="showTab('settings')">
                    ⚙️ Settings
                </button>
            </div>
            
            <!-- Live Trading Tab -->
            <div id="live-trading" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="card">
                        <h3>🤖 Bot Control</h3>
                        <div class="metric">
                            <span>Status: <span id="bot-status" class="status-stopped">Stopped</span></span>
                        </div>
                        <div class="metric">
                            <span>Trades Today: <span id="trades-today">0</span></span>
                        </div>
                        <div class="metric">
                            <span>Active Positions: <span id="active-positions">0</span></span>
                        </div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-success" onclick="startBot()">Start Bot</button>
                            <button class="btn btn-danger" onclick="stopBot()">Stop Bot</button>
                            <button class="btn btn-primary" onclick="forceRefresh()">🔄 Refresh</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>💰 Account Summary</h3>
                        <div class="metric">
                            <span>Account Equity: <span id="account-equity">$0.00</span></span>
                        </div>
                        <div class="metric">
                            <span>Cash Balance: <span id="cash-balance">$0.00</span></span>
                        </div>
                        <div class="metric">
                            <span>Daily P&L: <span id="daily-pnl">$0.00</span></span>
                        </div>
                        <div class="metric">
                            <span>Buying Power: <span id="buying-power">$0.00</span></span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>📊 Watchlist Summary</h3>
                        <div class="metric">
                            <span>Monitored Symbols: <span id="watchlist-count">0</span></span>
                        </div>
                        <div class="metric">
                            <span>Gap Opportunities: <span id="gap-opportunities">0</span></span>
                        </div>
                        <div class="metric">
                            <span>Last Scan: <span id="last-scan">Never</span></span>
                        </div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="runAnalysis()">🔍 Scan Market</button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>📊 Today's Watchlist</h3>
                    <div id="watchlist-container">
                        <p style="text-align: center; color: #7f8c8d; padding: 40px;">Loading watchlist data...</p>
                    </div>
                </div>
                
                <!-- Live Trading Logs -->
                <div class="card">
                    <h3>📋 Live Trading Logs</h3>
                    <div style="max-height: 350px; overflow-y: auto; margin-bottom: 15px;">
                        <div style="background: #2c3e50; color: white; padding: 20px; border-radius: 8px; font-family: monospace; font-size: 13px;">
                            <div id="live-trading-log">Loading live trading logs...</div>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-secondary btn-small" onclick="clearLiveTradingLog()">🗑️ Clear Logs</button>
                        <button class="btn btn-primary btn-small" onclick="loadLiveTradingLogs()">🔄 Refresh</button>
                        <button class="btn btn-warning btn-small" onclick="forceAnalysis()">⚡ Force Analysis</button>
                    </div>
                </div>
            </div>
            
            <!-- Backtesting Tab -->
            <div id="backtesting" class="tab-content">
                <div class="card">
                    <h3>🧪 Strategy Backtesting</h3>
                    <p style="color: #7f8c8d; margin-bottom: 20px;">Test the Velez gap trading strategy with historical data</p>
                    
                    <!-- Configuration Form -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <h4 style="margin-bottom: 15px;">📅 Date Range</h4>
                            <div class="preset-grid" style="grid-template-columns: 1fr;">
                                <div class="preset-card" onclick="selectDatePreset('last-30')">
                                    <h4>Last 30 Days</h4>
                                    <p>Recent market performance</p>
                                </div>
                                <div class="preset-card" onclick="selectDatePreset('last-quarter')">
                                    <h4>Last 3 Months</h4>
                                    <p>Quarterly analysis</p>
                                </div>
                                <div class="preset-card" onclick="selectDatePreset('ytd')">
                                    <h4>Year to Date</h4>
                                    <p>Current year performance</p>
                                </div>
                                <div class="preset-card" onclick="selectDatePreset('custom')">
                                    <h4>Custom Range</h4>
                                    <p>Set your own dates</p>
                                </div>
                            </div>
                            
                            <div id="custom-dates" style="display: none; margin-top: 15px;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Start Date</label>
                                        <input type="date" id="start-date" class="form-control">
                                        <small style="color: #7f8c8d; font-size: 11px;">Maximum 2 years ago</small>
                                    </div>
                                    <div class="form-group">
                                        <label>End Date</label>
                                        <input type="date" id="end-date" class="form-control">
                                        <small style="color: #7f8c8d; font-size: 11px;">Must be at least 1 day ago</small>
                                    </div>
                                </div>
                                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 10px; margin-top: 10px;">
                                    <small style="color: #856404;">
                                        <strong>📅 Date Range Tips:</strong><br>
                                        • End date must be yesterday or earlier (market data has a 1-day delay)<br>
                                        • Maximum range: 365 days<br>
                                        • Historical data available for last 2 years
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 style="margin-bottom: 15px;">📊 Symbol Selection</h4>
                            <div class="preset-grid" style="grid-template-columns: 1fr;">
                                <div class="preset-card" onclick="selectSymbolPreset('gap-favorites')">
                                    <h4>Gap Trading Favorites</h4>
                                    <p>Popular gap trading stocks</p>
                                    <div class="preset-symbols">
                                        <span class="symbol-tag">AAPL</span>
                                        <span class="symbol-tag">TSLA</span>
                                        <span class="symbol-tag">MSFT</span>
                                        <span class="symbol-tag">AMZN</span>
                                        <span class="symbol-tag">+6 more</span>
                                    </div>
                                </div>
                                <div class="preset-card" onclick="selectSymbolPreset('tech-stocks')">
                                    <h4>Technology Stocks</h4>
                                    <p>Major tech companies</p>
                                    <div class="preset-symbols">
                                        <span class="symbol-tag">GOOGL</span>
                                        <span class="symbol-tag">META</span>
                                        <span class="symbol-tag">NVDA</span>
                                        <span class="symbol-tag">AMD</span>
                                        <span class="symbol-tag">+6 more</span>
                                    </div>
                                </div>
                                <div class="preset-card" onclick="selectSymbolPreset('volatile-stocks')">
                                    <h4>High Volatility</h4>
                                    <p>Perfect for gap trading</p>
                                    <div class="preset-symbols">
                                        <span class="symbol-tag">TSLA</span>
                                        <span class="symbol-tag">AMD</span>
                                        <span class="symbol-tag">NFLX</span>
                                        <span class="symbol-tag">SHOP</span>
                                        <span class="symbol-tag">+6 more</span>
                                    </div>
                                </div>
                                <div class="preset-card" onclick="selectSymbolPreset('custom')">
                                    <h4>Custom Symbols</h4>
                                    <p>Enter your own list</p>
                                </div>
                            </div>
                            
                            <div id="custom-symbols" style="display: none; margin-top: 15px;">
                                <div class="form-group">
                                    <label>Stock Symbols (comma separated)</label>
                                    <textarea id="symbols-input" class="form-control" rows="3" 
                                              placeholder="AAPL, MSFT, TSLA, GOOGL..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Settings -->
                    <details style="margin: 20px 0;">
                        <summary style="cursor: pointer; font-weight: bold; color: #3498db;">⚙️ Advanced Settings</summary>
                        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Initial Capital</label>
                                    <input type="number" id="initial-capital" class="form-control" 
                                           value="100000" min="1000" step="1000">
                                </div>
                                <div class="form-group">
                                    <label>Commission per Share</label>
                                    <input type="number" id="commission" class="form-control" 
                                           value="0.005" min="0" step="0.001">
                                </div>
                            </div>
                        </div>
                    </details>
                    
                    <!-- Run Backtest Button -->
                    <div style="text-align: center; margin-top: 30px;">
                        <button id="run-backtest-btn" class="btn btn-primary" style="padding: 15px 40px; font-size: 16px;" 
                                onclick="runBacktest()">
                            🚀 Run Backtest
                        </button>
                        <button class="btn btn-warning" onclick="runDemoBacktest()" style="padding: 15px 30px; font-size: 16px;">
                            🎭 Demo Mode
                        </button>
                        <button class="btn btn-secondary" onclick="clearBacktestResults()">🗑️ Clear Results</button>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div id="backtest-progress" style="display: none; margin: 20px 0;">
                        <div class="progress-bar">
                            <div id="progress-fill" class="progress-fill" style="width: 0%;"></div>
                        </div>
                        <p id="progress-text" style="text-align: center; color: #7f8c8d;">Preparing backtest...</p>
                    </div>
                </div>
                
                <!-- Backtesting Analysis Logs -->
                <div class="card">
                    <h3>📋 Backtesting Analysis Logs</h3>
                    <p style="color: #7f8c8d; margin-bottom: 15px;">Real-time analysis during backtesting process</p>
                    <div style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
                        <div style="background: #2c3e50; color: white; padding: 20px; border-radius: 8px; font-family: monospace; font-size: 13px;">
                            <div id="backtest-analysis-log">No backtesting logs yet. Run a backtest to see real-time analysis...</div>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-secondary btn-small" onclick="clearBacktestAnalysisLog()">🗑️ Clear Logs</button>
                        <button class="btn btn-primary btn-small" onclick="loadBacktestAnalysisLogs()">🔄 Refresh</button>
                    </div>
                </div>
                
                <!-- Results Section -->
                <div id="backtest-results" style="display: none;">
                    <div class="card">
                        <h3>📊 Backtest Results</h3>
                        
                        <!-- Key Metrics -->
                        <div class="results-grid">
                            <div class="metric-card">
                                <div id="total-return" class="metric-value">-</div>
                                <div class="metric-label">Total Return</div>
                            </div>
                            <div class="metric-card">
                                <div id="win-rate" class="metric-value">-</div>
                                <div class="metric-label">Win Rate</div>
                            </div>
                            <div class="metric-card">
                                <div id="total-trades" class="metric-value">-</div>
                                <div class="metric-label">Total Trades</div>
                            </div>
                            <div class="metric-card">
                                <div id="profit-factor" class="metric-value">-</div>
                                <div class="metric-label">Profit Factor</div>
                            </div>
                            <div class="metric-card">
                                <div id="max-drawdown" class="metric-value">-</div>
                                <div class="metric-label">Max Drawdown</div>
                            </div>
                            <div class="metric-card">
                                <div id="sharpe-ratio" class="metric-value">-</div>
                                <div class="metric-label">Sharpe Ratio</div>
                            </div>
                        </div>
                        
                        <!-- Charts -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h4>📈 Equity Curve</h4>
                                <div class="chart-container">
                                    <canvas id="equity-chart"></canvas>
                                </div>
                            </div>
                            <div>
                                <h4>📊 Monthly Returns</h4>
                                <div class="chart-container">
                                    <canvas id="monthly-returns-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Trade Log -->
                        <div style="margin-top: 20px;">
                            <h4>📋 Trade Log</h4>
                            <div id="trade-log" class="trade-log">
                                <p style="color: #7f8c8d; text-align: center;">No trades to display</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Positions Tab -->
            <div id="positions" class="tab-content">
                <div class="card">
                    <h3>📈 Active Positions</h3>
                    <div id="positions-container">
                        <p style="text-align: center; color: #7f8c8d; padding: 40px;">Loading positions...</p>
                    </div>
                </div>
            </div>
            
            <!-- Analysis Tab -->
            <div id="analysis" class="tab-content">
                <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                    <!-- Live Trading Analysis -->
                    <div class="card">
                        <h3>🔍 Live Trading Analysis</h3>
                        <p style="color: #7f8c8d; margin-bottom: 15px;">Real-time trading decisions and gap analysis</p>
                        <div style="max-height: 350px; overflow-y: auto; margin-bottom: 15px;">
                            <div style="background: #2c3e50; color: white; padding: 20px; border-radius: 8px; font-family: monospace; font-size: 13px;">
                                <div id="analysis-log">Loading trading analysis...</div>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <button class="btn btn-secondary btn-small" onclick="clearAnalysisLog()">🗑️ Clear</button>
                            <button class="btn btn-primary btn-small" onclick="loadAnalysis()">🔄 Refresh</button>
                            <button class="btn btn-warning btn-small" onclick="forceAnalysis()">⚡ Force Analysis</button>
                        </div>
                    </div>
                    
                    <!-- System Activity Logs -->
                    <div class="card">
                        <h3>🖥️ System Activity</h3>
                        <p style="color: #7f8c8d; margin-bottom: 15px;">Bot operations, API calls, and system events</p>
                        <div style="max-height: 350px; overflow-y: auto; margin-bottom: 15px;">
                            <div style="background: #2c3e50; color: white; padding: 20px; border-radius: 8px; font-family: monospace; font-size: 13px;">
                                <div id="system-activity-log">Loading system activity...</div>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <button class="btn btn-secondary btn-small" onclick="clearSystemActivityLog()">🗑️ Clear</button>
                            <button class="btn btn-primary btn-small" onclick="loadSystemActivity()">🔄 Refresh</button>
                        </div>
                    </div>
                </div>
                
                <!-- Analysis Summary -->
                <div class="card">
                    <h3>📊 Analysis Summary</h3>
                    <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                        <div class="metric-card">
                            <div id="total-scans-today" class="metric-value">-</div>
                            <div class="metric-label">Scans Today</div>
                        </div>
                        <div class="metric-card">
                            <div id="setups-found-today" class="metric-value">-</div>
                            <div class="metric-label">Setups Found</div>
                        </div>
                        <div class="metric-card">
                            <div id="last-analysis-time-display" class="metric-value">-</div>
                            <div class="metric-label">Last Analysis</div>
                        </div>
                        <div class="metric-card">
                            <div id="analysis-success-rate" class="metric-value">-</div>
                            <div class="metric-label">Success Rate</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="card">
                    <h3>⚙️ Bot Settings</h3>
                    <p style="color: #7f8c8d;">Configure trading parameters and risk management</p>
                    
                    <div class="form-group">
                        <label>Max Trades Per Day</label>
                        <input type="number" class="form-control" value="10" min="1" max="50">
                    </div>
                    
                    <div class="form-group">
                        <label>Risk Per Trade (%)</label>
                        <input type="number" class="form-control" value="1.0" min="0.1" max="5.0" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label>Gap Threshold (%)</label>
                        <input type="number" class="form-control" value="1.5" min="0.5" max="10.0" step="0.1">
                    </div>
                    
                    <button class="btn btn-primary">Save Settings</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Tab Management
        function showTab(tabId) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active from all buttons
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
            
            // Load tab-specific data
            switch(tabId) {
                case 'live-trading':
                    loadLiveTradingData();
                    loadLiveTradingLogs();
                    break;
                case 'backtesting':
                    loadBacktestingPresets();
                    loadBacktestAnalysisLogs();
                    break;
                case 'positions':
                    loadPositions();
                    break;
                case 'analysis':
                    loadAnalysis();
                    loadSystemActivity();
                    break;
            }
        }
        
        // Backtesting Functions
        let selectedDatePreset = 'last-30';
        let selectedSymbolPreset = 'gap-favorites';
        
        function selectDatePreset(preset) {
            selectedDatePreset = preset;
            
            // Update UI
            document.querySelectorAll('#backtesting .preset-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.preset-card').classList.add('selected');
            
            // Show/hide custom date inputs
            const customDates = document.getElementById('custom-dates');
            if (preset === 'custom') {
                customDates.style.display = 'block';
            } else {
                customDates.style.display = 'none';
                setDatePreset(preset);
            }
        }
        
        function selectSymbolPreset(preset) {
            selectedSymbolPreset = preset;
            
            // Update UI
            document.querySelectorAll('#backtesting .preset-card').forEach(card => {
                if (card.onclick && card.onclick.toString().includes('selectSymbolPreset')) {
                    card.classList.remove('selected');
                }
            });
            event.target.closest('.preset-card').classList.add('selected');
            
            // Show/hide custom symbol input
            const customSymbols = document.getElementById('custom-symbols');
            if (preset === 'custom') {
                customSymbols.style.display = 'block';
            } else {
                customSymbols.style.display = 'none';
            }
        }
        
        function setDatePreset(preset) {
            const today = new Date();
            const startDate = document.getElementById('start-date');
            const endDate = document.getElementById('end-date');
            
            // Set end date to yesterday (to avoid future date issues)
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            endDate.value = yesterday.toISOString().split('T')[0];
            
            switch(preset) {
                case 'last-30':
                    const thirtyDaysAgo = new Date(yesterday);
                    thirtyDaysAgo.setDate(yesterday.getDate() - 30);
                    startDate.value = thirtyDaysAgo.toISOString().split('T')[0];
                    break;
                case 'last-quarter':
                    const quarterAgo = new Date(yesterday);
                    quarterAgo.setMonth(yesterday.getMonth() - 3);
                    startDate.value = quarterAgo.toISOString().split('T')[0];
                    break;
                case 'ytd':
                    const currentYear = today.getFullYear();
                    // If we're in January and it's early in the year, use previous year
                    if (today.getMonth() === 0 && today.getDate() < 15) {
                        startDate.value = `${currentYear - 1}-01-01`;
                    } else {
                        startDate.value = `${currentYear}-01-01`;
                    }
                    break;
            }
        }
        
        function getSymbolsForPreset(preset) {
            const presets = {
                'gap-favorites': ['AAPL', 'TSLA', 'MSFT', 'AMZN', 'GOOGL', 'META', 'NVDA', 'AMD', 'NFLX', 'PYPL'],
                'tech-stocks': ['AAPL', 'MSFT', 'GOOGL', 'META', 'AMZN', 'NVDA', 'AMD', 'INTC', 'ORCL', 'CRM'],
                'volatile-stocks': ['TSLA', 'AMD', 'NFLX', 'PYPL', 'SQ', 'ROKU', 'ZM', 'SHOP', 'SNAP', 'TWTR']
            };
            return presets[preset] || [];
        }
        
        async function runDemoBacktest() {
            const runBtn = document.getElementById('run-backtest-btn');
            const progressDiv = document.getElementById('backtest-progress');
            const resultsDiv = document.getElementById('backtest-results');
            
            // Clear previous backtesting logs
            document.getElementById('backtest-analysis-log').innerHTML = '';
            
            // Disable button and show progress
            runBtn.disabled = true;
            runBtn.textContent = '🎭 Running Demo...';
            progressDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            
            try {
                // Update progress and add logs
                updateProgress(10, 'Initializing demo environment...');
                addBacktestLog('🎭 Demo Mode: Starting simulated backtest', 'info');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                updateProgress(20, 'Preparing demo backtest...');
                addBacktestLog('📊 Loading demo symbols: AAPL, TSLA, MSFT, GOOGL, AMD', 'info');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                addBacktestLog('📅 Demo date range: Last 30 days with simulated data', 'info');
                updateProgress(40, 'Generating mock historical data...');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                addBacktestLog('🔍 Analyzing gap opportunities in demo data...', 'setup');
                updateProgress(50, 'Running strategy analysis...');
                
                // Make API call to demo endpoint
                const response = await fetch('/api/backtesting/demo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                updateProgress(70, 'Generating demo results...');
                addBacktestLog('📈 Found 5 demo trades with mixed P&L results', 'success');
                await new Promise(resolve => setTimeout(resolve, 300));
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.detail || 'Demo backtest failed');
                }
                
                updateProgress(85, 'Processing demo trades...');
                addBacktestLog('✅ AAPL: Entry $150.25 → Exit $155.75 (+$550.00)', 'success');
                addBacktestLog('❌ TSLA: Entry $245.80 → Exit $240.15 (-$282.50)', 'error');
                addBacktestLog('✅ MSFT: Entry $415.30 → Exit $422.90 (+$190.00)', 'success');
                await new Promise(resolve => setTimeout(resolve, 300));
                
                updateProgress(90, 'Loading demo data...');
                addBacktestLog('📊 Calculating performance metrics...', 'info');
                
                // Display results (same as regular backtest)
                displayBacktestResults(result);
                
                updateProgress(100, 'Demo complete!');
                addBacktestLog('🎉 Demo backtest completed successfully!', 'success');
                addBacktestLog(`📈 Final Results: 3/5 wins (60%), Total P&L: +$457.50`, 'success');
                
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 2000);
                
            } catch (error) {
                console.error('Demo backtest error:', error);
                addBacktestLog(`❌ Demo Error: ${error.message}`, 'error');
                updateProgress(0, `Demo Error: ${error.message}`);
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 3000);
            } finally {
                // Re-enable button
                runBtn.disabled = false;
                runBtn.textContent = '🚀 Run Backtest';
            }
        }

        async function runBacktest() {
            const runBtn = document.getElementById('run-backtest-btn');
            const progressDiv = document.getElementById('backtest-progress');
            const resultsDiv = document.getElementById('backtest-results');
            
            // Clear previous backtesting logs
            document.getElementById('backtest-analysis-log').innerHTML = '';
            
            // Disable button and show progress
            runBtn.disabled = true;
            runBtn.textContent = '⏳ Running Backtest...';
            progressDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            
            try {
                // Prepare request data
                const requestData = {
                    symbols: selectedSymbolPreset === 'custom' ? 
                        document.getElementById('symbols-input').value.split(',').map(s => s.trim().toUpperCase()) :
                        getSymbolsForPreset(selectedSymbolPreset),
                    start_date: document.getElementById('start-date').value,
                    end_date: document.getElementById('end-date').value,
                    initial_capital: parseFloat(document.getElementById('initial-capital').value),
                    commission_per_share: parseFloat(document.getElementById('commission').value)
                };
                
                // Validate data
                if (!requestData.symbols || requestData.symbols.length === 0) {
                    throw new Error('Please select symbols to backtest');
                }
                if (!requestData.start_date || !requestData.end_date) {
                    throw new Error('Please select date range');
                }
                
                // Validate date range
                const startDate = new Date(requestData.start_date);
                const endDate = new Date(requestData.end_date);
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Reset time to start of today
                
                if (endDate >= today) {
                    throw new Error('End date cannot be today or in the future. Please select a date at least 1 day ago.');
                }
                
                if (startDate >= endDate) {
                    throw new Error('Start date must be before end date');
                }
                
                const daysDifference = (endDate - startDate) / (1000 * 60 * 60 * 24);
                if (daysDifference < 1) {
                    throw new Error('Date range must be at least 1 day');
                }
                
                if (daysDifference > 365) {
                    throw new Error('Date range cannot exceed 365 days. Please select a shorter period.');
                }
                
                // Add backtesting logs
                updateProgress(5, 'Initializing backtest engine...');
                addBacktestLog('🚀 Starting real historical backtest', 'info');
                addBacktestLog(`📊 Symbols: ${requestData.symbols.join(', ')}`, 'info');
                addBacktestLog(`📅 Date Range: ${requestData.start_date} to ${requestData.end_date}`, 'info');
                addBacktestLog(`💰 Initial Capital: $${requestData.initial_capital.toLocaleString()}`, 'info');
                
                // Update progress
                updateProgress(10, 'Preparing backtest...');
                addBacktestLog('📡 Connecting to Alpaca API for historical data...', 'info');
                
                // Make API call
                const response = await fetch('/api/backtesting/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                updateProgress(30, 'Downloading historical data...');
                addBacktestLog('⬇️ Downloading 1-minute historical bars...', 'info');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                updateProgress(50, 'Processing historical data...');
                addBacktestLog('🔍 Analyzing gap patterns and VWAP levels...', 'setup');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.detail || 'Backtest failed');
                }
                
                updateProgress(75, 'Running Velez strategy simulation...');
                addBacktestLog('⚡ Executing gap trading strategy...', 'setup');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                updateProgress(90, 'Generating results...');
                addBacktestLog('📊 Calculating performance metrics...', 'info');
                
                // Display results
                displayBacktestResults(result);
                
                updateProgress(100, 'Backtest complete!');
                addBacktestLog('🎉 Backtest completed successfully!', 'success');
                
                if (result.summary) {
                    addBacktestLog(`📈 Results: ${result.summary.total_trades} trades, ${result.summary.win_rate}% win rate`, 'success');
                    addBacktestLog(`💵 Total P&L: ${result.summary.total_return_pct >= 0 ? '+' : ''}${result.summary.total_return_pct}%`, 
                                  result.summary.total_return_pct >= 0 ? 'success' : 'error');
                }
                
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 2000);
                
            } catch (error) {
                console.error('Backtest error:', error);
                addBacktestLog(`❌ Backtest Error: ${error.message}`, 'error');
                updateProgress(0, `Error: ${error.message}`);
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 3000);
            } finally {
                // Re-enable button
                runBtn.disabled = false;
                runBtn.textContent = '🚀 Run Backtest';
            }
        }
        
        function updateProgress(percent, text) {
            document.getElementById('progress-fill').style.width = `${percent}%`;
            document.getElementById('progress-text').textContent = text;
        }
        
        function displayBacktestResults(results) {
            if (!results.success) {
                throw new Error(results.error || 'Backtest failed');
            }
            
            if (!results.summary) {
                throw new Error('No results summary available. The backtest may have completed but produced no trades.');
            }
            
            const summary = results.summary;
            
            // Update metrics
            document.getElementById('total-return').textContent = `${summary.total_return_pct >= 0 ? '+' : ''}${summary.total_return_pct.toFixed(2)}%`;
            document.getElementById('total-return').className = `metric-value ${summary.total_return_pct >= 0 ? 'metric-positive' : 'metric-negative'}`;
            
            document.getElementById('win-rate').textContent = `${summary.win_rate.toFixed(1)}%`;
            document.getElementById('win-rate').className = `metric-value ${summary.win_rate >= 50 ? 'metric-positive' : 'metric-negative'}`;
            
            document.getElementById('total-trades').textContent = summary.total_trades;
            document.getElementById('profit-factor').textContent = summary.profit_factor.toFixed(2);
            document.getElementById('profit-factor').className = `metric-value ${summary.profit_factor >= 1 ? 'metric-positive' : 'metric-negative'}`;
            
            document.getElementById('max-drawdown').textContent = `${summary.max_drawdown.toFixed(2)}%`;
            document.getElementById('max-drawdown').className = `metric-value metric-negative`;
            
            document.getElementById('sharpe-ratio').textContent = summary.sharpe_ratio.toFixed(2);
            document.getElementById('sharpe-ratio').className = `metric-value ${summary.sharpe_ratio >= 1 ? 'metric-positive' : 'metric-neutral'}`;
            
            // Get detailed results for charts and trade log
            loadDetailedResults();
            
            // Show results
            document.getElementById('backtest-results').style.display = 'block';
        }
        
        async function loadDetailedResults() {
            try {
                // Try demo results first
                let response = await fetch('/api/backtesting/demo/detailed');
                let data;
                
                if (response.ok) {
                    data = await response.json();
                } else {
                    // Fall back to regular results
                    response = await fetch('/api/backtesting/results/detailed');
                    if (response.ok) {
                        data = await response.json();
                    }
                }
                
                if (data && data.equity_curve) {
                    drawEquityCurve(data.equity_curve);
                    displayTradeLog(data.trades);
                }
            } catch (error) {
                console.error('Failed to load detailed results:', error);
            }
        }
        
        function drawEquityCurve(equityData) {
            const ctx = document.getElementById('equity-chart').getContext('2d');
            
            // Clear any existing chart
            if (window.equityChart instanceof Chart) {
                window.equityChart.destroy();
            }
            
            const labels = equityData.map(point => new Date(point.timestamp).toLocaleDateString());
            const data = equityData.map(point => point.equity);
            
            window.equityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Account Equity',
                        data: data,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        function displayTradeLog(trades) {
            const tradeLog = document.getElementById('trade-log');
            
            if (!trades || trades.length === 0) {
                tradeLog.innerHTML = '<p style="color: #7f8c8d; text-align: center;">No trades executed</p>';
                return;
            }
            
            let html = '';
            trades.forEach((trade, index) => {
                const pnl = trade.pnl || 0;
                const pnlClass = pnl > 0 ? 'profit' : 'loss';
                const duration = trade.hold_duration_minutes ? `${trade.hold_duration_minutes}m` : 'N/A';
                
                html += `
                    <div class="trade-item ${pnlClass}">
                        <div class="trade-header">
                            <span>${trade.symbol}</span>
                            <span class="${pnl >= 0 ? 'metric-positive' : 'metric-negative'}">
                                ${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}
                            </span>
                        </div>
                        <div class="trade-details">
                            Entry: $${trade.entry_price.toFixed(2)} → Exit: $${trade.exit_price ? trade.exit_price.toFixed(2) : 'N/A'} | 
                            Qty: ${trade.quantity} | Duration: ${duration} | Reason: ${trade.exit_reason || 'N/A'}
                        </div>
                    </div>
                `;
            });
            
            tradeLog.innerHTML = html;
        }
        
        function clearBacktestResults() {
            document.getElementById('backtest-results').style.display = 'none';
            document.getElementById('backtest-progress').style.display = 'none';
            
            // Clear charts
            if (window.equityChart instanceof Chart) {
                window.equityChart.destroy();
            }
        }
        
        // Logging Functions
        function logToContainer(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const now = new Date().toLocaleTimeString();
            
            const colorClass = type === 'setup' ? 'color: #27ae60; font-weight: bold;' : 
                              type === 'skip' ? 'color: #f39c12;' : 
                              type === 'error' ? 'color: #e74c3c;' : 
                              type === 'success' ? 'color: #2ecc71; font-weight: bold;' :
                              type === 'warning' ? 'color: #f39c12;' : 'color: #ecf0f1;';
            
            const icon = type === 'setup' ? '🎯' :
                        type === 'error' ? '❌' :
                        type === 'warning' ? '⚠️' :
                        type === 'success' ? '✅' :
                        type === 'skip' ? '⏭️' : 'ℹ️';
            
            container.innerHTML += `<div style="${colorClass} margin: 2px 0; padding: 2px 0; border-bottom: 1px solid #34495e;">
                <span style="font-family: monospace; color: #7f8c8d;">[${now}]</span>
                <span style="margin: 0 5px;">${icon}</span>
                <span>${message}</span>
            </div>`;
            
            container.scrollTop = container.scrollHeight;
        }
        
        async function loadLiveTradingLogs() {
            try {
                const response = await fetch('/api/v1/bot/analysis-logs');
                const data = await response.json();
                
                const container = document.getElementById('live-trading-log');
                
                if (data.logs && data.logs.length > 0) {
                    let html = '';
                    data.logs.slice(-20).forEach(log => { // Show last 20 logs
                        const time = new Date(log.timestamp).toLocaleTimeString();
                        const color = log.type === 'success' ? '#27ae60' : 
                                    log.type === 'warning' ? '#f39c12' : 
                                    log.type === 'error' ? '#e74c3c' : '#ecf0f1';
                        const icon = log.type === 'success' ? '✅' : 
                                   log.type === 'warning' ? '⚠️' : 
                                   log.type === 'error' ? '❌' : 'ℹ️';
                        
                        const symbolText = log.symbol ? `<span style="background: #34495e; padding: 1px 4px; border-radius: 3px; font-size: 10px;">${log.symbol}</span>` : '';
                        
                        html += `<div style="color: ${color}; margin: 2px 0; padding: 2px 0; border-bottom: 1px solid #34495e;">
                            <span style="color: #7f8c8d;">[${time}]</span>
                            <span style="margin: 0 5px;">${icon}</span>
                            ${symbolText}
                            <span style="margin-left: 5px;">${log.message}</span>
                        </div>`;
                    });
                    container.innerHTML = html || '<div style="color: #95a5a6;">No recent trading logs</div>';
                } else {
                    container.innerHTML = '<div style="color: #95a5a6;">No trading analysis logs yet. Start the bot to see real-time analysis.</div>';
                }
                
            } catch (error) {
                console.error('Failed to load live trading logs:', error);
                document.getElementById('live-trading-log').innerHTML = 
                    '<div style="color: #e74c3c;">Failed to load trading logs. Check API connection.</div>';
            }
        }
        
        function clearLiveTradingLog() {
            document.getElementById('live-trading-log').innerHTML = 
                '<div style="color: #95a5a6;">Trading logs cleared. New logs will appear here...</div>';
        }
        
        function clearBacktestAnalysisLog() {
            document.getElementById('backtest-analysis-log').innerHTML = 
                '<div style="color: #95a5a6;">Backtesting logs cleared. Run a backtest to see new analysis...</div>';
        }
        
        function loadBacktestAnalysisLogs() {
            // This will be populated during actual backtesting
            // For now, show placeholder
            const container = document.getElementById('backtest-analysis-log');
            container.innerHTML = '<div style="color: #95a5a6;">Run a backtest to see real-time analysis logs here...</div>';
        }
        
        async function loadSystemActivity() {
            const container = document.getElementById('system-activity-log');
            
            // Mock system activity for demonstration
            const now = new Date().toLocaleTimeString();
            let html = `
                <div style="color: #2ecc71;">[${now}] 🔄 Dashboard refreshed successfully</div>
                <div style="color: #3498db;">[${(new Date(Date.now() - 30000)).toLocaleTimeString()}] 📡 API connection established</div>
                <div style="color: #f39c12;">[${(new Date(Date.now() - 60000)).toLocaleTimeString()}] ⚠️ Market data timeout, retrying...</div>
                <div style="color: #2ecc71;">[${(new Date(Date.now() - 90000)).toLocaleTimeString()}] ✅ Watchlist scan completed - 10 symbols</div>
                <div style="color: #e67e22;">[${(new Date(Date.now() - 120000)).toLocaleTimeString()}] 🔍 Gap analysis started</div>
                <div style="color: #95a5a6;">[${(new Date(Date.now() - 180000)).toLocaleTimeString()}] ℹ️ Bot startup sequence initiated</div>
            `;
            
            container.innerHTML = html;
        }
        
        function clearSystemActivityLog() {
            document.getElementById('system-activity-log').innerHTML = 
                '<div style="color: #95a5a6;">System activity log cleared.</div>';
        }
        
        function clearAnalysisLog() {
            document.getElementById('analysis-log').innerHTML = 
                '<div style="color: #95a5a6;">Analysis log cleared. New analysis will appear here...</div>';
        }
        
        // Add backtesting log functionality
        function addBacktestLog(message, type = 'info') {
            logToContainer('backtest-analysis-log', message, type);
        }

        // Live Trading Functions
        async function loadLiveTradingData() {
            try {
                // Load basic bot status
                const statusResponse = await fetch('/api/v1/bot/status');
                const statusData = await statusResponse.json();
                
                if (statusData.bot_status) {
                    const status = statusData.bot_status;
                    document.getElementById('bot-status').textContent = status.is_running ? 'Running' : 'Stopped';
                    document.getElementById('bot-status').className = status.is_running ? 'status-running' : 'status-stopped';
                    document.getElementById('trades-today').textContent = status.trades_today || 0;
                    document.getElementById('active-positions').textContent = status.active_positions || 0;
                }
                
                // Load account data
                const accountResponse = await fetch('/api/v1/trading/account-summary');
                const accountData = await accountResponse.json();
                
                document.getElementById('account-equity').textContent = formatCurrency(accountData.account_equity || 0);
                document.getElementById('cash-balance').textContent = formatCurrency(accountData.cash || 0);
                document.getElementById('daily-pnl').textContent = formatCurrency(accountData.daily_pnl || 0);
                document.getElementById('buying-power').textContent = formatCurrency(accountData.buying_power || 0);
                
                // Load watchlist
                loadWatchlist();
                
            } catch (error) {
                console.error('Failed to load live trading data:', error);
            }
        }
        
        async function loadWatchlist() {
            try {
                const response = await fetch('/api/v1/bot/watchlist');
                const data = await response.json();
                
                document.getElementById('watchlist-count').textContent = data.count || 0;
                document.getElementById('gap-opportunities').textContent = data.summary?.gappers || 0;
                document.getElementById('last-scan').textContent = data.last_updated ? 
                    new Date(data.last_updated).toLocaleTimeString() : 'Never';
                
                const container = document.getElementById('watchlist-container');
                
                if (data.count > 0 && data.watchlist) {
                    let html = `
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 10px; text-align: left;">Symbol</th>
                                        <th style="padding: 10px; text-align: right;">Price</th>
                                        <th style="padding: 10px; text-align: right;">Gap %</th>
                                        <th style="padding: 10px; text-align: right;">Volume</th>
                                        <th style="padding: 10px; text-align: center;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    for (const [symbol, item] of Object.entries(data.watchlist)) {
                        const gapPercent = item.gap_percent || item.premarket_gap_percent || 0;
                        const gapColor = gapPercent > 0 ? '#27ae60' : '#e74c3c';
                        const volumeStr = item.volume > 1000000 ? `${(item.volume / 1000000).toFixed(1)}M` : 
                                         item.volume > 1000 ? `${(item.volume / 1000).toFixed(0)}K` : item.volume?.toString() || 'N/A';
                        
                        html += `
                            <tr style="border-bottom: 1px solid #dee2e6;">
                                <td style="padding: 10px; font-weight: bold;">${symbol}</td>
                                <td style="padding: 10px; text-align: right;">$${item.current_price?.toFixed(2) || 'N/A'}</td>
                                <td style="padding: 10px; text-align: right; color: ${gapColor}; font-weight: bold;">
                                    ${gapPercent > 0 ? '+' : ''}${gapPercent.toFixed(2)}%
                                </td>
                                <td style="padding: 10px; text-align: right;">${volumeStr}</td>
                                <td style="padding: 10px; text-align: center;">
                                    <span style="background: #3498db; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;">
                                        Monitoring
                                    </span>
                                </td>
                            </tr>
                        `;
                    }
                    
                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 40px;">No stocks in watchlist</p>';
                }
                
            } catch (error) {
                console.error('Failed to load watchlist:', error);
                document.getElementById('watchlist-container').innerHTML = 
                    '<p style="text-align: center; color: #e74c3c; padding: 40px;">Failed to load watchlist</p>';
            }
        }
        
        async function loadPositions() {
            try {
                // First try to get bot's active positions which have stop/target data
                const botResponse = await fetch('/api/v1/bot/active-positions');
                const botData = await botResponse.json();

                // Also get regular positions for current price and P&L
                const posResponse = await fetch('/api/v1/trading/positions');
                const posData = await posResponse.json();

                const container = document.getElementById('positions-container');

                // Merge data from both endpoints
                const positions = [];
                if (botData.active_positions && Object.keys(botData.active_positions).length > 0) {
                    for (const [symbol, botPos] of Object.entries(botData.active_positions)) {
                        // Find matching position from trading endpoint for current price
                        const tradingPos = posData.positions?.find(p => p.symbol === symbol);

                        positions.push({
                            symbol: symbol,
                            entry_price: botPos.entry_price,
                            current_price: tradingPos?.current_price || botPos.entry_price,
                            unrealized_pnl: tradingPos?.unrealized_pnl || 0,
                            quantity: botPos.quantity,
                            stop_loss: botPos.stop_loss,
                            target_price: botPos.target_1,
                            entry_time: botPos.entry_time
                        });
                    }
                } else if (posData.positions && posData.positions.length > 0) {
                    // Fallback to regular positions if no bot positions
                    positions.push(...posData.positions);
                }

                if (positions.length > 0) {
                    let html = '';
                    positions.forEach(position => {
                        const pnlColor = position.unrealized_pnl >= 0 ? '#27ae60' : '#e74c3c';
                        const stopLoss = position.stop_loss || 0;
                        const target = position.target_price || 0;
                        const currentPrice = position.current_price || position.entry_price;

                        html += `
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 4px solid ${pnlColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span style="font-weight: bold; font-size: 16px;">${position.symbol}</span>
                                    <div style="display: flex; align-items: center; gap: 15px;">
                                        <span style="color: ${pnlColor}; font-weight: bold;">
                                            ${position.unrealized_pnl >= 0 ? '+' : ''}$${position.unrealized_pnl.toFixed(2)}
                                        </span>
                                        <button class="btn btn-danger btn-small"
                                                onclick="closePosition('${position.symbol}')"
                                                style="margin: 0; white-space: nowrap;">
                                            ✕ Close
                                        </button>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; font-size: 13px; color: #7f8c8d; margin-bottom: 8px;">
                                    <div><strong>Entry:</strong> $${position.entry_price.toFixed(2)}</div>
                                    <div><strong>Current:</strong> $${currentPrice.toFixed(2)}</div>
                                    <div><strong>Qty:</strong> ${position.quantity}</div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px; padding-top: 8px; border-top: 1px solid #dee2e6;">
                                    <div style="color: #e74c3c;">
                                        <strong>🛑 Stop Loss:</strong> $${stopLoss.toFixed(2)}
                                        ${stopLoss > 0 ? `<span style="font-size: 11px; color: #95a5a6;"> (${((stopLoss - currentPrice) / currentPrice * 100).toFixed(1)}%)</span>` : ''}
                                    </div>
                                    <div style="color: #27ae60;">
                                        <strong>🎯 Target:</strong> $${target.toFixed(2)}
                                        ${target > 0 ? `<span style="font-size: 11px; color: #95a5a6;"> (+${((target - currentPrice) / currentPrice * 100).toFixed(1)}%)</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 40px;">No active positions</p>';
                }

            } catch (error) {
                console.error('Failed to load positions:', error);
                document.getElementById('positions-container').innerHTML =
                    '<p style="text-align: center; color: #e74c3c; padding: 40px;">Failed to load positions</p>';
            }
        }

        async function closePosition(symbol) {
            if (!confirm(`Are you sure you want to close position for ${symbol}?`)) {
                return;
            }

            try {
                document.getElementById('status-message').textContent = `Closing position for ${symbol}...`;
                document.getElementById('status-message').className = 'status-loading';

                const response = await fetch(`/api/v1/bot/close-position/${symbol}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    document.getElementById('status-message').textContent = `Position closed for ${symbol}`;
                    document.getElementById('status-message').className = 'status-running';

                    // Refresh positions after a short delay
                    setTimeout(() => {
                        loadPositions();
                        loadLiveTradingData();
                    }, 1000);
                } else {
                    throw new Error(result.detail || 'Failed to close position');
                }

            } catch (error) {
                console.error('Failed to close position:', error);
                document.getElementById('status-message').textContent = `Failed to close ${symbol}: ${error.message}`;
                document.getElementById('status-message').className = 'status-stopped';
                alert(`Failed to close position for ${symbol}: ${error.message}`);
            }
        }
        
        async function loadAnalysis() {
            try {
                const response = await fetch('/api/v1/bot/analysis-logs');
                const data = await response.json();
                
                const container = document.getElementById('analysis-log');
                
                if (data.logs && data.logs.length > 0) {
                    let html = '';
                    data.logs.forEach(log => {
                        const time = new Date(log.timestamp).toLocaleTimeString();
                        const color = log.type === 'success' ? '#27ae60' : 
                                    log.type === 'warning' ? '#f39c12' : 
                                    log.type === 'error' ? '#e74c3c' : '#ecf0f1';
                        
                        html += `<div style="color: ${color};">[${time}] ${log.message}</div>`;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="color: #95a5a6;">No analysis logs available. Start the bot to see real-time analysis.</div>';
                }
                
            } catch (error) {
                console.error('Failed to load analysis:', error);
                document.getElementById('analysis-log').innerHTML = 
                    '<div style="color: #e74c3c;">Failed to load analysis logs</div>';
            }
        }
        
        // Bot Control Functions
        async function startBot() {
            try {
                document.getElementById('status-message').textContent = 'Starting bot...';
                document.getElementById('status-message').className = 'status-loading';
                
                await fetch('/api/v1/bot/start', { method: 'POST' });
                setTimeout(loadLiveTradingData, 2000);
                
            } catch (error) {
                console.error('Failed to start bot:', error);
                document.getElementById('status-message').textContent = 'Start failed';
                document.getElementById('status-message').className = 'status-stopped';
            }
        }
        
        async function stopBot() {
            try {
                document.getElementById('status-message').textContent = 'Stopping bot...';
                document.getElementById('status-message').className = 'status-loading';
                
                await fetch('/api/v1/bot/stop', { method: 'POST' });
                setTimeout(loadLiveTradingData, 2000);
                
            } catch (error) {
                console.error('Failed to stop bot:', error);
                document.getElementById('status-message').textContent = 'Stop failed';
                document.getElementById('status-message').className = 'status-stopped';
            }
        }
        
        async function runAnalysis() {
            try {
                document.getElementById('status-message').textContent = 'Running market analysis...';
                document.getElementById('status-message').className = 'status-loading';
                
                await fetch('/api/v1/bot/force-scan', { method: 'POST' });
                setTimeout(() => {
                    loadWatchlist();
                    document.getElementById('status-message').textContent = 'Analysis complete';
                    document.getElementById('status-message').className = 'status-running';
                }, 2000);
                
            } catch (error) {
                console.error('Failed to run analysis:', error);
                document.getElementById('status-message').textContent = 'Analysis failed';
                document.getElementById('status-message').className = 'status-stopped';
            }
        }
        
        async function forceRefresh() {
            const currentTab = document.querySelector('.tab-content.active').id;
            
            switch(currentTab) {
                case 'live-trading':
                    await loadLiveTradingData();
                    break;
                case 'positions':
                    await loadPositions();
                    break;
                case 'analysis':
                    await loadAnalysis();
                    break;
            }
        }
        
        // Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount || 0);
        }
        
        function loadBacktestingPresets() {
            // Set date input constraints
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const twoYearsAgo = new Date(today);
            twoYearsAgo.setFullYear(today.getFullYear() - 2);
            
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            
            // Set constraints
            startDateInput.min = twoYearsAgo.toISOString().split('T')[0];
            startDateInput.max = yesterday.toISOString().split('T')[0];
            endDateInput.min = twoYearsAgo.toISOString().split('T')[0];
            endDateInput.max = yesterday.toISOString().split('T')[0];
            
            // Initialize default date range
            setDatePreset('last-30');
        }
        
        async function forceAnalysis() {
            try {
                document.getElementById('status-message').textContent = 'Forcing analysis...';
                document.getElementById('status-message').className = 'status-loading';

                await fetch('/api/v1/bot/force-analysis', { method: 'POST' });

                setTimeout(() => {
                    loadAnalysis();
                    loadLiveTradingLogs();
                    document.getElementById('status-message').textContent = 'Analysis complete';
                    document.getElementById('status-message').className = 'status-running';
                }, 2000);

            } catch (error) {
                console.error('Failed to force analysis:', error);
                document.getElementById('status-message').textContent = 'Analysis failed';
                document.getElementById('status-message').className = 'status-stopped';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loaded');
            loadLiveTradingData();
            loadLiveTradingLogs();
            loadBacktestingPresets();

            // Auto refresh every 30 seconds for live trading tab
            setInterval(() => {
                const currentTab = document.querySelector('.tab-content.active').id;
                if (currentTab === 'live-trading') {
                    forceRefresh();
                    loadLiveTradingLogs(); // Refresh logs too
                }
            }, 30000);

            // Auto refresh live trading logs every 10 seconds when on live trading tab
            setInterval(() => {
                const currentTab = document.querySelector('.tab-content.active').id;
                if (currentTab === 'live-trading') {
                    loadLiveTradingLogs();
                }
            }, 10000);

            // Auto refresh positions every 60 seconds (1 minute) when on positions tab
            setInterval(() => {
                const currentTab = document.querySelector('.tab-content.active').id;
                if (currentTab === 'positions') {
                    loadPositions();
                }
            }, 60000);
        });
    </script>
</body>
</html>