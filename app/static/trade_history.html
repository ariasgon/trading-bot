<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade History & P/L Analytics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .stat {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .stat-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
        }

        .stat-value.positive {
            color: #10b981;
        }

        .stat-value.negative {
            color: #ef4444;
        }

        .filters {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .filters h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-input {
            display: flex;
            flex-direction: column;
        }

        .filter-input label {
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .filter-input input,
        .filter-input select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .filter-input button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
            margin-top: auto;
        }

        .filter-input button:hover {
            background: #5568d3;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th, td {
            padding: 15px;
            text-align: left;
        }

        th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: background 0.2s ease;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .winner {
            color: #10b981;
            font-weight: 600;
        }

        .loser {
            color: #ef4444;
            font-weight: 600;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-filled {
            background: #10b981;
            color: white;
        }

        .badge-pending {
            background: #f59e0b;
            color: white;
        }

        .badge-cancelled {
            background: #6b7280;
            color: white;
        }

        .badge-long {
            background: #3b82f6;
            color: white;
        }

        .badge-short {
            background: #ef4444;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab:hover {
            background: #f3f4f6;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .stat-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 0.9em;
            }

            th, td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Trade History & P/L Analytics</h1>

        <div id="error" class="error" style="display: none;"></div>
        <div id="loading" class="loading">Loading trade data...</div>

        <!-- P/L Summary Dashboard -->
        <div id="summary-dashboard" class="dashboard" style="display: none;">
            <div class="card">
                <h2>Total Performance</h2>
                <div class="stat">
                    <div class="stat-label">Total P/L</div>
                    <div class="stat-value" id="total-pnl">$0.00</div>
                </div>
                <div class="stat-grid" style="margin-top: 15px;">
                    <div class="stat">
                        <div class="stat-label">Total Trades</div>
                        <div class="stat-value" id="total-trades">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Win Rate</div>
                        <div class="stat-value" id="win-rate">0%</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Wins vs Losses</h2>
                <div class="stat-grid">
                    <div class="stat">
                        <div class="stat-label">Winners</div>
                        <div class="stat-value positive" id="winners">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Losers</div>
                        <div class="stat-value negative" id="losers">0</div>
                    </div>
                </div>
                <div class="stat-grid" style="margin-top: 15px;">
                    <div class="stat">
                        <div class="stat-label">Avg Winner</div>
                        <div class="stat-value positive" id="avg-winner">$0.00</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Avg Loser</div>
                        <div class="stat-value negative" id="avg-loser">$0.00</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Best & Worst</h2>
                <div class="stat">
                    <div class="stat-label">Best Trade</div>
                    <div class="stat-value positive" id="best-trade">$0.00</div>
                    <div class="stat-label" id="best-symbol" style="margin-top: 5px; font-size: 0.9em;"></div>
                </div>
                <div class="stat" style="margin-top: 15px;">
                    <div class="stat-label">Worst Trade</div>
                    <div class="stat-value negative" id="worst-trade">$0.00</div>
                    <div class="stat-label" id="worst-symbol" style="margin-top: 5px; font-size: 0.9em;"></div>
                </div>
            </div>

            <div class="card">
                <h2>Risk Management</h2>
                <div class="stat">
                    <div class="stat-label">Avg R-Multiple</div>
                    <div class="stat-value" id="avg-r-multiple">0.00R</div>
                </div>
                <div class="stat" style="margin-top: 15px;">
                    <div class="stat-label">Profit Factor</div>
                    <div class="stat-value" id="profit-factor">0.00</div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters" style="display: none;" id="filters-section">
            <h3>Filters</h3>
            <div class="filter-group">
                <div class="filter-input">
                    <label>Symbol</label>
                    <input type="text" id="filter-symbol" placeholder="e.g., AAPL">
                </div>
                <div class="filter-input">
                    <label>Strategy</label>
                    <select id="filter-strategy">
                        <option value="">All Strategies</option>
                        <option value="proprietary">Proprietary</option>
                        <option value="velez">Velez</option>
                    </select>
                </div>
                <div class="filter-input">
                    <label>Status</label>
                    <select id="filter-status">
                        <option value="">All Statuses</option>
                        <option value="filled">Filled</option>
                        <option value="pending">Pending</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="filter-input">
                    <label>Period (Days)</label>
                    <input type="number" id="filter-days" value="30" min="1" max="365">
                </div>
                <div class="filter-input">
                    <button onclick="applyFilters()">Apply Filters</button>
                </div>
                <div class="filter-input">
                    <button onclick="resetFilters()" style="background: #6b7280;">Reset</button>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs" style="display: none;" id="tabs-section">
            <button class="tab active" onclick="showTab('trades')">Closed Trades</button>
            <button class="tab" onclick="showTab('orders')">Recent Orders</button>
        </div>

        <!-- Trade History Table -->
        <div id="trades-tab" class="tab-content active">
            <table id="trades-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Side</th>
                        <th>Quantity</th>
                        <th>Entry</th>
                        <th>Exit</th>
                        <th>P/L</th>
                        <th>R-Multiple</th>
                        <th>Duration</th>
                        <th>Entry Time</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="trades-tbody">
                </tbody>
            </table>
        </div>

        <!-- Orders Table -->
        <div id="orders-tab" class="tab-content">
            <table id="orders-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Side</th>
                        <th>Type</th>
                        <th>Quantity</th>
                        <th>Filled</th>
                        <th>Price</th>
                        <th>Status</th>
                        <th>Submitted</th>
                    </tr>
                </thead>
                <tbody id="orders-tbody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let currentFilters = {
            symbol: '',
            strategy: '',
            status: '',
            days: 30
        };

        async function loadData() {
            try {
                // Load analytics summary
                const summaryResponse = await fetch(`/api/v1/history/analytics/summary?days=${currentFilters.days}`);
                if (!summaryResponse.ok) throw new Error('Failed to load analytics');
                const summaryData = await summaryResponse.json();
                displaySummary(summaryData);

                // Load trades
                const tradesResponse = await fetch(`/api/v1/history/trades?limit=100`);
                if (!tradesResponse.ok) throw new Error('Failed to load trades');
                const tradesData = await tradesResponse.json();
                displayTrades(tradesData.trades);

                // Load orders
                const ordersResponse = await fetch(`/api/v1/history/orders/recent?limit=50`);
                if (!ordersResponse.ok) throw new Error('Failed to load orders');
                const ordersData = await ordersResponse.json();
                displayOrders(ordersData.orders);

                // Show UI elements
                document.getElementById('loading').style.display = 'none';
                document.getElementById('summary-dashboard').style.display = 'grid';
                document.getElementById('filters-section').style.display = 'block';
                document.getElementById('tabs-section').style.display = 'flex';
                document.getElementById('trades-table').style.display = 'table';
                document.getElementById('orders-table').style.display = 'table';
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = `Error loading data: ${error.message}`;
                errorDiv.style.display = 'block';
            }
        }

        function displaySummary(data) {
            if (!data.summary) return;

            const summary = data.summary;

            // Total P/L
            const pnlEl = document.getElementById('total-pnl');
            pnlEl.textContent = `$${summary.total_pnl.toFixed(2)}`;
            pnlEl.className = `stat-value ${summary.total_pnl >= 0 ? 'positive' : 'negative'}`;

            // Stats
            document.getElementById('total-trades').textContent = summary.total_trades;
            document.getElementById('win-rate').textContent = `${summary.win_rate.toFixed(1)}%`;
            document.getElementById('winners').textContent = summary.winning_trades;
            document.getElementById('losers').textContent = summary.losing_trades;
            document.getElementById('avg-winner').textContent = `$${summary.average_winner.toFixed(2)}`;
            document.getElementById('avg-loser').textContent = `$${summary.average_loser.toFixed(2)}`;

            // Best/Worst
            if (data.best_trade) {
                document.getElementById('best-trade').textContent = `$${data.best_trade.pnl.toFixed(2)}`;
                document.getElementById('best-symbol').textContent = data.best_trade.symbol;
            }
            if (data.worst_trade) {
                document.getElementById('worst-trade').textContent = `$${data.worst_trade.pnl.toFixed(2)}`;
                document.getElementById('worst-symbol').textContent = data.worst_trade.symbol;
            }

            // Risk
            document.getElementById('avg-r-multiple').textContent = `${summary.average_r_multiple.toFixed(2)}R`;
            document.getElementById('profit-factor').textContent = summary.profit_factor.toFixed(2);
        }

        function displayTrades(trades) {
            const tbody = document.getElementById('trades-tbody');
            tbody.innerHTML = '';

            if (!trades || trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 30px; color: #666;">No trades found</td></tr>';
                return;
            }

            trades.forEach(trade => {
                const row = document.createElement('tr');

                const pnl = trade.realized_pnl || 0;
                const pnlClass = pnl >= 0 ? 'winner' : 'loser';
                const duration = trade.duration_minutes ? `${trade.duration_minutes}m` : '-';

                row.innerHTML = `
                    <td><strong>${trade.symbol}</strong></td>
                    <td><span class="badge badge-${trade.side}">${trade.side}</span></td>
                    <td>${trade.quantity}</td>
                    <td>$${(trade.entry_price || 0).toFixed(2)}</td>
                    <td>$${(trade.exit_price || 0).toFixed(2)}</td>
                    <td class="${pnlClass}">$${pnl.toFixed(2)}</td>
                    <td>${trade.r_multiple ? trade.r_multiple.toFixed(2) + 'R' : '-'}</td>
                    <td>${duration}</td>
                    <td>${trade.entry_time ? new Date(trade.entry_time).toLocaleString() : '-'}</td>
                    <td><span class="badge badge-${trade.status}">${trade.status}</span></td>
                `;

                tbody.appendChild(row);
            });
        }

        function displayOrders(orders) {
            const tbody = document.getElementById('orders-tbody');
            tbody.innerHTML = '';

            if (!orders || orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #666;">No orders found</td></tr>';
                return;
            }

            orders.forEach(order => {
                const row = document.createElement('tr');

                const price = order.filled_avg_price || order.limit_price || order.stop_price || '-';
                const priceText = typeof price === 'number' ? `$${price.toFixed(2)}` : price;

                row.innerHTML = `
                    <td><strong>${order.symbol}</strong></td>
                    <td><span class="badge badge-${order.side}">${order.side}</span></td>
                    <td>${order.type}</td>
                    <td>${order.qty}</td>
                    <td>${order.filled_qty || 0}</td>
                    <td>${priceText}</td>
                    <td><span class="badge badge-${order.status}">${order.status}</span></td>
                    <td>${order.submitted_at ? new Date(order.submitted_at).toLocaleString() : '-'}</td>
                `;

                tbody.appendChild(row);
            });
        }

        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Show/hide tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        function applyFilters() {
            currentFilters = {
                symbol: document.getElementById('filter-symbol').value,
                strategy: document.getElementById('filter-strategy').value,
                status: document.getElementById('filter-status').value,
                days: parseInt(document.getElementById('filter-days').value) || 30
            };
            loadData();
        }

        function resetFilters() {
            document.getElementById('filter-symbol').value = '';
            document.getElementById('filter-strategy').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-days').value = '30';
            currentFilters = { symbol: '', strategy: '', status: '', days: 30 };
            loadData();
        }

        // Load data on page load
        loadData();

        // Refresh every 30 seconds
        setInterval(loadData, 30000);
    </script>
</body>
</html>
